{% extends "base.html" %}
{% load static %}
{% load analytics_custom_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/balances.css' %}">
{% endblock %}

{% block content %}
{% load static %}
<h1>Остатки за {{ current_year }} год</h1>

<!-- Форма выбора года -->
<form method="get" action="" style="margin-bottom:20px;">
    <label for="year">Выберите год:</label>
    <select name="year" id="year" onchange="this.form.submit()">
        {% for year in years %}
            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
    </select>
</form>

<div class="table-container">
    <table class="summary-table">
        <thead>
            <tr>
                <th rowspan="2" class="left">Плательщик/получатель</th>
                <th rowspan="2">Входящий остаток</th>
                {% for month in months_name %}
                    <th>{{ month }}</th>
                {% endfor %}
                <th>Итого</th>
            </tr>
        </thead>

        
        
        <tbody>
            <tr>
                <td class="left" style="background:#d9edf7; font-weight:bold;">
                    Приход денег
                </td>
            </tr>
            {% for participant_name, participant_data in participants_data.items %}
            <tr>
                
                <td class="left">{{ participant_name }}</td>
                <td>
                    <input type="number" step="0.01" 
                        value="{{ participant_data.incoming_balance }}" 
                        class="incoming-balance" 
                        data-participant="{{ participant_data.participant.id }}"
                        data-year="{{ current_year }}" 
                        style="width:80px; text-align:right;">
                        
                </td>
                
                    {% for month in months %}
                        {% with month_data=participant_data.monthly|get_item:month %}
                            {% if month_data %}
                                <td class="border-strong {% if month_data.accrued < 0 %}negative{% endif %}">{{ month_data.income|stringformat:".2f" }}</td>
                            {% else %}
                                <td>0</td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                    <td class="border-strong {% if participant_data.year_total.income < 0 %}negative{% endif %}">{{ participant_data.year_total.income|stringformat:".2f" }}</td>
                
            </tr>
            {% endfor %}

            <tr>
                <td class="left" style="background:#d9edf7; font-weight:bold;">
                    Выбытие денег
                </td>
            </tr>
             {% for participant_name, participant_data in participants_data.items %}
            <tr>
               
                <td class="left">{{ participant_name }}</td>
                <td>
                    <input type="number" step="0.01" 
                        value="{{ participant_data.incoming_balance }}" 
                        class="incoming-balance" 
                        data-participant="{{ participant_data.participant.id }}"
                        data-year="{{ current_year }}" 
                        style="width:80px; text-align:right;">
                        
                </td>
                
                    {% for month in months %}
                        {% with month_data=participant_data.monthly|get_item:month %}
                            {% if month_data %}
                                <td class="border-strong {% if month_data.accrued < 0 %}negative{% endif %}">{{ month_data.expense|stringformat:".2f" }}</td>
                            {% else %}
                                <td>0</td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                    <td class="border-strong {% if participant_data.year_total.expense < 0 %}negative{% endif %}">{{ participant_data.year_total.expense|stringformat:".2f" }}</td>
                
            </tr>
            {% endfor %}

            <tr>
                <td class="left" style="background:#d9edf7; font-weight:bold;">
                    Остаток на конец месяца
                </td>
            </tr>
            {% for participant_name, participant_data in participants_data.items %}
            <tr>
                
                <td class="left">{{ participant_name }}</td>
                <td>
                    <input type="number" step="0.01" 
                        value="{{ participant_data.incoming_balance }}" 
                        class="incoming-balance" 
                        data-participant="{{ participant_data.participant.id }}"
                        data-year="{{ current_year }}" 
                        style="width:80px; text-align:right;">
                       
                        
                </td>
                
                    {% for month in months %}
                        {% with month_data=participant_data.monthly|get_item:month %}
                            {% if month_data %}
                                <td class="border-strong {% if month_data.balance < 0 %}negative{% endif %}">{{ month_data.balance|stringformat:".2f" }}</td>
                            {% else %}
                                <td>0</td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                    <td class="border-strong {% if participant_data.year_total.balance < 0 %}negative{% endif %}">{{ participant_data.year_total.balance|stringformat:".2f" }}</td>
                
            </tr>
            {% endfor %}

        </tbody>
        

    </table>
</div>

<style>
.table-container {
    overflow: auto;
    width: 100%;
    max-height: 80vh;
}

table.summary-table {
    border-collapse: collapse;
    min-width: 1400px;
}

table.summary-table th,
table.summary-table td {
    border: 1px solid #999;
    padding: 6px;
    white-space: nowrap;
    text-align: right;
}

table.summary-table th {
    background-color: #f2f2f2;
    position: sticky;
    top: 0;
    z-index: 3;
}



td.left, th.left {
    text-align: left !important; /* текст слева */
    padding-left: 8px; /* отступ от левого края для красоты */
    position: sticky;
    left: 0;
    background-color: #f9f9f9;
    z-index: 2;
}

/* Пересечение шапки и левой колонки */
thead th.left {
    z-index: 6; /* самое высокое значение, чтобы оставалась сверху и при вертикальном, и при горизонтальном скролле */
}

.negative {
    color: red;
    font-weight: bold;
}

/* Отрицательная вариация */
.border-strong {
    border-left: 3px solid #333 !important;
}

</style>

<script src="{% static 'js/balances.js' %}"></script>
{% endblock %}

