{% extends "base.html" %}
{% load static %}
{% load analytics_custom_tags %}
{% block title %}Задолженность{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dept.css' %}">
{% endblock %}
{% block content %}
{% load static %}

<div class="summary-top">
    <h2 class="summary-head">Задолженность за {{ current_year }} год</h2>

    <!-- Кастомный dropdown -->
    <form method="get" action="">
        <div class="dropdown">
            <div class="dropdown-toggle" id="selected-year">
                Год: {{ current_year }}
            </div>
            <div class="dropdown-menu">
                {% for year in years %}
                    <div class="dropdown-item {% if year == current_year %}active{% endif %}" data-value="{{ year }}">
                        Год: {{ year }}
                    </div>
                {% endfor %}
            </div>
            <input type="hidden" name="year" id="year-input" value="{{ current_year }}">
        </div>
    </form>
</div>

<div class="table-container">
    <div class="table-head">
        <div class="head-info">
            <div class="head-column head-column--counterparty">
            <span class="head-title">Агент</span>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 12H14M8 8H12M8 4H10M2 5.58333L3.00345 4.45445C3.53384 3.85776 4.46616 3.85776 4.99655 4.45445L6 5.58333M4 4V12" stroke="#A5A5A5" stroke-width="1.2" stroke-linecap="round"/>
            </svg>
            </div>
            <div class="head-column head-column--incoming-balance">
                <span class="head-title">Входящий остаток</span>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 12H14M8 8H12M8 4H10M2 5.58333L3.00345 4.45445C3.53384 3.85776 4.46616 3.85776 4.99655 4.45445L6 5.58333M4 4V12" stroke="#A5A5A5" stroke-width="1.2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        {% for month in months_name %}
        <div class="head-period">
            <div class="head-column head-column--month">
                <span class="head-title">{{ month }}</span>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 12H14M8 8H12M8 4H10M2 5.58333L3.00345 4.45445C3.53384 3.85776 4.46616 3.85776 4.99655 4.45445L6 5.58333M4 4V12" stroke="#A5A5A5" stroke-width="1.2" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="head-column head-column--finance">
                <div class="finance-head finance-head--accrued">Начислено</div>
                <div class="finance-head finance-head--paid">Выплачено</div>
                <div class="finance-head finance-head--balance">Остаток</div>
            </div>
        </div>
        {% endfor %}
        <div class="head-period">
            <div class="head-column head-column--total">
                    <span class="head-title">Итого</span>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 12H14M8 8H12M8 4H10M2 5.58333L3.00345 4.45445C3.53384 3.85776 4.46616 3.85776 4.99655 4.45445L6 5.58333M4 4V12" stroke="#A5A5A5" stroke-width="1.2" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="head-column head-column--finance">
                    <div class="finance-head finance-head--accrued">Начислено</div>
                    <div class="finance-head finance-head--paid">Выплачено</div>
                    <div class="finance-head finance-head--balance">Остаток</div>
            </div>
        </div>
    </div>
    <div class="block-data"> 
    <div class="data-row">
        
        <div class="counterparty-data">
            {% for counterparty_name, counterparty_data in counterparties_data.items %}
            <div class="counterparty-data-row">
                <div class="data-cell data-cell--counterparty">
                    <div class="women_portrait"></div>
                    <span class="title-text">{{ counterparty_name }}</span>
                </div>
                <div class="data-cell data-cell--incoming-balance">
                    <input type="number" step="0.01" 
                        value="{{ counterparty_data.incoming_balance }}" 
                        class="input-balance" 
                        data-counterparty="{{ counterparty_data.counterparty.id }}"
                        data-year="{{ current_year }}">    
                </div>
            </div>
            {% endfor %}
        </div>
        {% for month in months %}
        <div class="period-data">
            {% for counterparty_name, counterparty_data in counterparties_data.items %}
            <div class="period-data-row">
                {% with month_data=counterparty_data.monthly|get_item:month %}
                <div class="data-cell data-cell--accrued">
                    {{ month_data.accrued|default:0|stringformat:".2f" }}
                </div>
                <div class="data-cell data-cell--paid">
                    {{ month_data.paid|default:0|stringformat:".2f" }}
                </div>
                <div class="data-cell data-cell--balance">
                    {{ month_data.balance|default:0|stringformat:".2f" }}
                </div>
                {% endwith %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        <div class="period-data">
            {% for counterparty_name, counterparty_data in counterparties_data.items %}
            <div class="period-data-row">
                <div class="data-cell data-cell--accrued">
                    {{ counterparty_data.year_total.accrued|stringformat:".2f" }}
                </div>
                <div class="data-cell data-cell--paid">
                    {{ counterparty_data.year_total.paid|stringformat:".2f" }}
                </div>
                <div class="data-cell data-cell--balance">
                    {{ counterparty_data.year_total.balance|stringformat:".2f" }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    </div> 
</div>


<script src="{% static 'js/dept.js' %}"></script>
{% endblock %}

