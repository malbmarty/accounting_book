{% extends "base.html" %}
{% load custom_tags %}
{% block content %}
{% load static %}
<h1>Сводка по зарплатам за {{ current_year }} год</h1>

<!-- Форма выбора года -->
<form method="get" action="" style="margin-bottom:20px;">
    <label for="year">Выберите год:</label>
    <select name="year" id="year" onchange="this.form.submit()">
        {% for year in years %}
            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
    </select>
</form>

<div class="table-container">
    <table class="summary-table">
        <thead>
            <tr>
                <th rowspan="2" class="left">Сотрудник</th>
                <th rowspan="2">Входящий остаток</th>
                {% for month in months_name %}
                    <th colspan="3">{{ month }}</th>
                {% endfor %}
                <th colspan="3">Итого</th>
            </tr>
            <tr>
                {% for month in months %}
                    <th>Начислено</th>
                    <th>Выплачено</th>
                    <th>Остаток</th>
                {% endfor %}
                <th>Начислено</th>
                <th>Выплачено</th>
                <th>Остаток</th>
            </tr>
        </thead>

        {% for dept_name, employees in department_data.items %}
        <tbody>
            <!-- Заголовок отдела -->
            <tr>
                <td class="left" style="background:#d9edf7; font-weight:bold;">
                    {{ dept_name }}
                </td>
            </tr>

            {% for emp_data in employees %}
            <tr>
                <td class="left">{{ emp_data.employee.full_name }}</td>
                <td>
                    <input type="number" step="0.01" 
                        value="{{ emp_data.incoming_balance }}" 
                        class="incoming-balance" 
                        data-employee="{{ emp_data.employee.id }}"
                        data-year="{{ current_year }}" 
                        style="width:80px; text-align:right;">
                        
                </td>
                {% with total_accrued=0 total_paid=0 total_balance=emp_data.incoming_balance %}
                    {% for month in months %}
                        {% with month_data=emp_data.monthly|dict_get:month %}
                            {% if month_data %}
                                <td>{{ month_data.accrued|stringformat:".2f" }}</td>
                                <td>{{ month_data.paid|stringformat:".2f" }}</td>
                                <td class="{% if month_data.balance < 0 %}negative{% endif %}">{{ month_data.balance|stringformat:".2f" }}</td>
                                {% with total_accrued=total_accrued|add:month_data.accrued %}
                                {% with total_paid=total_paid|add:month_data.paid %}
                                {% with total_balance=month_data.balance %}
                                {% endwith %}{% endwith %}{% endwith %}
                            {% else %}
                                <td>0</td><td>0</td><td>0</td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                    <td>{{ emp_data.year_total.accrued|stringformat:".2f" }}</td>
                    <td>{{ emp_data.year_total.paid|stringformat:".2f" }}</td>
                    <td class="{% if total_balance < 0 %}negative{% endif %}">{{ emp_data.year_total.balance|stringformat:".2f" }}</td>
                {% endwith %}
            </tr>
            {% endfor %}

            <!-- Итоги по отделу -->
            <tr style="font-weight:bold; background:#e0e0e0;">
                <td class="left">Итого по отделу</td>
                <td>-</td>
                {% with dept_tot=department_totals|dict_get:dept_name %}
                    {% for month in months %}
                        {% with month_tot=dept_tot.monthly|dict_get:month %}
                            <td>{{ month_tot.accrued|stringformat:".2f" }}</td>
                            <td>{{ month_tot.paid|stringformat:".2f" }}</td>
                            <td class="{% if month_tot.balance < 0 %}negative{% endif %}">{{ month_tot.balance|stringformat:".2f" }}</td>
                        {% endwith %}
                    {% endfor %}
                    <td>{{ dept_tot.year_total.accrued|stringformat:".2f" }}</td>
                    <td>{{ dept_tot.year_total.paid|stringformat:".2f" }}</td>
                    <td class="{% if dept_tot.year_total.balance < 0 %}negative{% endif %}">{{ dept_tot.year_total.balance|stringformat:".2f" }}</td>
                {% endwith %}
            </tr>
        </tbody>
        {% endfor %}
        <tfoot>
            <tr style="background-color: #d0e9c6; font-weight: bold;">
                <td class="left">Итого по компании</td>
                <td>-</td>
                {% for month in months %}
                    {% with month_tot=company_totals.monthly|dict_get:month %}
                        <td>{{ month_tot.accrued|stringformat:".2f" }}</td>
                        <td>{{ month_tot.paid|stringformat:".2f" }}</td>
                        <td class="{% if month_tot.balance < 0 %}negative{% endif %}">{{ month_tot.balance|stringformat:".2f" }}</td>
                    {% endwith %}
                {% endfor %}
                <td>{{ company_totals.year_total.accrued|stringformat:".2f" }}</td>
                <td>{{ company_totals.year_total.paid|stringformat:".2f" }}</td>
                <td class="{% if company_totals.year_total.balance < 0 %}negative{% endif %}">{{ company_totals.year_total.balance|stringformat:".2f" }}</td>
            </tr>
        </tfoot>
    </table>
</div>

<style>
.table-container {
    overflow: auto;
    width: 100%;
    max-height: 80vh;
}

table.summary-table {
    border-collapse: collapse;
    min-width: 1400px;
}

table.summary-table th,
table.summary-table td {
    border: 1px solid #999;
    padding: 6px;
    white-space: nowrap;
    text-align: right;
}

table.summary-table th {
    background-color: #f2f2f2;
    position: sticky;
    top: 0;
    z-index: 3;
}



td.left, th.left {
    text-align: left !important; /* текст слева */
    padding-left: 8px; /* отступ от левого края для красоты */
    position: sticky;
    left: 0;
    background-color: #f9f9f9;
    z-index: 2;
}

/* Пересечение шапки и левой колонки */
thead th.left {
    z-index: 6; /* самое высокое значение, чтобы оставалась сверху и при вертикальном, и при горизонтальном скролле */
}

.negative {
    color: red;
    font-weight: bold;
}
</style>

<script src="{% static 'js/summary.js' %}"></script>
{% endblock %}



